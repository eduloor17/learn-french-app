<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>French Companion - Flashcards & Conversations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos básicos para la aplicación */
        :root {
            --color-practice: #4f46e5; /* Indigo-600 */
            --color-practice-text: white;
            --color-conversations: #10b981; /* Emerald-500/Green-600 */
            --color-conversations-text: white;
        }
        body {
            background-color: #f3f4f6; /* Gray-100 */
        }
        #notification-box {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            z-index: 1000;
            min-width: 300px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Flashcard Flip CSS */
        .flip-container {
            perspective: 1000px;
            height: 100%;
            cursor: pointer;
        }
        .flip-container > div {
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
            width: 100%;
            height: 100%;
        }
        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1.5rem;
            padding: 2rem;
            box-sizing: border-box;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .front {
            background-color: white;
            z-index: 2;
        }
        .back {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            transform: rotateY(180deg);
        }
        .flipped > div {
            transform: rotateY(180deg);
        }
        .flipped .back {
            z-index: 3;
        }
        /* Common Button Styles */
        .listen-btn {
            background-color: #f0fdf4; /* Green-50 */
            color: #10b981; /* Green-600 */
            padding: 0.5rem 1rem;
            border-radius: 9999px; /* Full rounded */
            font-weight: 600;
            border: 1px solid #d1fae5;
            transition: all 0.15s;
        }
        .listen-btn:hover {
            background-color: #d1fae5; /* Green-100 */
        }
        .action-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: white;
            transition: all 0.15s;
            box-shadow: 0 4px #4f46e5; /* Base Indigo-600 shadow */
            background-color: #4f46e5;
            cursor: pointer;
        }
        .action-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 5px #4338ca;
        }
        .action-btn:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px #4338ca;
        }
    </style>

    <script>
        // --- DATA (DEBES DEFINIR ESTAS CONSTANTES AQUÍ) ---
        // Debes reemplazar estos placeholders con tus datos reales
        const LESSONS = [
            // Ejemplo de una lección
            { title: "Verbs: Être & Avoir", progressKey: "lesson1", cards: [
                { french: "Tu es (Être)", frenchAudio: "Tu es", english: "You are (To be)", phonetic: "/ty ɛ/", lessonTitle: "Être & Avoir" },
                { french: "J'ai (Avoir)", frenchAudio: "J'ai", english: "I have (To have)", phonetic: "/ʒe/", lessonTitle: "Être & Avoir" }
            ]},
            // Ejemplo de otra lección
            { title: "Verbs: Aller, Faire...", progressKey: "lesson2", cards: [
                { french: "Nous allons (Aller)", english: "We go (To go)", phonetic: "/nu z‿a.lɔ̃/", lessonTitle: "Aller, Faire..." },
            ]},
        ];

        const CONVERSATIONS = [
            // Ejemplo de una conversación
            { 
                topic: "Ordering Coffee", 
                question: "Que voulez-vous boire ?", 
                answers: [
                    { text: "Je voudrais un café, s'il vous plaît.", phonetic: "/ʒə vu.dʁe œ̃ ka.fe sil vu plɛ/" },
                    { text: "Un thé vert, merci.", phonetic: "/œ̃ te vɛʁ mɛʁ.si/" }
                ]
            },
        ];
        
        // --- FIREBASE AND PROGRESS MANAGEMENT (DEBES IMPLEMENTAR ESTO) ---
        // Función placeholder. Asegúrate de implementar la lógica real de Firebase.
        window.currentProgress = {}; 
        window.currentProgress['lesson1'] = true; // Simulación de progreso
        window.currentProgress['lesson2'] = false;
        
        function initFirebase() {
            // Lógica real de inicialización de Firebase y carga de progreso...
            console.log("Firebase initialized. Progress loaded.");
            document.getElementById('user-id-display').textContent = 'User: Guest (Progress Simulation)';
            
            // Iniciar la aplicación una vez que todo está cargado
            window.selectLesson(0);
        }

        function saveProgress() {
            console.log("Progress saved to Firebase.");
            // Lógica real para guardar window.currentProgress...
        }
        // ------------------------------------------------------------------


        // --- GLOBAL STATE ---
        window.currentMode = 'practice'; // 'practice', 'review', or 'conversations'
        window.currentLessonIndex = 0;
        window.currentCardIndex = 0;
        window.currentConversationIndex = 0;
        window.isFlipped = false;
        window.activeCardList = []; // The list of cards currently being viewed

        // --- UTILITIES ---
        window.showNotification = (message, type = 'success') => {
            const box = document.getElementById('notification-box');
            box.textContent = message;
            box.style.opacity = 1;

            let bgColor;
            switch (type) {
                case 'error': bgColor = '#ef4444'; break; // Red-500
                case 'info': bgColor = '#3b82f6'; break;  // Blue-500
                case 'warning': bgColor = '#f59e0b'; break; // Amber-500
                default: bgColor = '#10b981'; // Green-500 (success)
            }
            box.style.backgroundColor = bgColor;

            setTimeout(() => {
                box.style.opacity = 0;
            }, 3000);
        };

        // --- NAVIGATION AND MODE FUNCTIONS ---

        window.changeView = (mode) => {
            window.currentMode = mode;
            window.isFlipped = false;
            if (mode === 'practice') {
                window.selectLesson(window.currentLessonIndex);
            } else if (mode === 'conversations') {
                window.currentConversationIndex = 0;
                renderApp();
            }
            // Note: 'review' mode is started via startSpeedReview()
        };

        window.selectLesson = (index) => {
            window.currentMode = 'practice';
            window.currentLessonIndex = index;
            window.currentCardIndex = 0;
            window.isFlipped = false;
            window.activeCardList = LESSONS[index].cards;
            renderApp();
        };

        window.startSpeedReview = () => {
            window.currentMode = 'review';
            window.currentCardIndex = 0;
            window.isFlipped = false;

            // Collect ALL cards from ALL completed lessons
            let reviewList = [];
            LESSONS.forEach(lesson => {
                if (window.currentProgress[lesson.progressKey]) {
                    // Add lesson context to the card for review mode
                    const cardsWithContext = lesson.cards.map(card => ({
                        ...card, 
                        lessonTitle: lesson.title
                    }));
                    reviewList = reviewList.concat(cardsWithContext);
                }
            });

            if (reviewList.length === 0) {
                showNotification('Complete al menos una lección para comenzar la Revisión Rápida.', 'warning');
                window.currentMode = 'practice';
                renderApp();
                return;
            }

            // Shuffle the cards (simple Fisher-Yates shuffle)
            for (let i = reviewList.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [reviewList[i], reviewList[j]] = [reviewList[j], reviewList[i]];
            }

            window.activeCardList = reviewList;
            showNotification(`Starting Speed Review with ${reviewList.length} cards!`);
            renderApp();
        };

        window.flipCard = () => {
            window.isFlipped = !window.isFlipped;
            renderApp();
        };

        window.nextCard = () => {
            const list = window.activeCardList;
            if (window.currentCardIndex < list.length - 1) {
                window.currentCardIndex++;
                window.isFlipped = false;
                renderApp();
            } else {
                if (window.currentMode === 'practice') {
                    const lesson = LESSONS[window.currentLessonIndex];
                    markLessonComplete(lesson.progressKey);
                    showNotification(`Lesson "${lesson.title}" completed!`);
                    if (window.currentLessonIndex < LESSONS.length - 1) {
                        window.selectLesson(window.currentLessonIndex + 1);
                    } else {
                        window.selectLesson(0);
                    }
                } else { // Review Mode finished
                    showNotification(`Speed Review finished! You reviewed ${list.length} cards.`);
                    window.selectLesson(0);
                }
            }
        };

        window.prevCard = () => {
            if (window.currentCardIndex > 0) {
                window.currentCardIndex--;
                window.isFlipped = false;
                renderApp();
            }
        };

        const markLessonComplete = (key) => {
            if (!window.currentProgress[key]) {
                window.currentProgress[key] = true;
                saveProgress();
            }
        };

        // --- CONVERSATION MODE FUNCTIONS ---
        
        window.nextConversation = () => {
            if (window.currentConversationIndex < CONVERSATIONS.length - 1) {
                window.currentConversationIndex++;
                renderApp();
            } else {
                window.currentConversationIndex = 0;
                showNotification("Looping back to the first conversation topic.", 'info');
                renderApp();
            }
        };

        window.prevConversation = () => {
            if (window.currentConversationIndex > 0) {
                window.currentConversationIndex--;
                renderApp();
            }
        };

        // --- SPEECH & AUDIO FUNCTIONS ---

        // Initialize SpeechSynthesis
        const synth = window.speechSynthesis;
        let frenchVoice = null;

        const setFrenchVoice = () => {
            if (frenchVoice) return;
            const voices = synth.getVoices();
            frenchVoice = voices.find(
                (voice) => voice.lang.startsWith('fr') && (voice.name.includes('Google') || voice.name.includes('Microsoft'))
            );
            if (!frenchVoice) {
                frenchVoice = voices.find((voice) => voice.lang.startsWith('fr'));
            }
            if (!frenchVoice) {
                console.warn('No se encontró una voz en francés adecuada.');
            }
        };

        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = setFrenchVoice;
        } else {
            setFrenchVoice();
        }
        
        window.handleListenClick = (text) => {
            if (!synth) {
                showNotification('Speech Synthesis no está soportado en tu navegador.', 'error');
                return;
            }
            if (synth.speaking) {
                synth.cancel();
            }

            setFrenchVoice();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';
            if (frenchVoice) {
                utterance.voice = frenchVoice;
            } else {
                utterance.pitch = 1.0;
                utterance.rate = 1.0;
            }

            utterance.onerror = (event) => {
                console.error('SpeechSynthesisUtterance.onerror', event);
                showNotification('Error al reproducir audio.', 'error');
            };

            synth.speak(utterance);
        };

        // --- MICROPHONE RECORDING FUNCTIONS (Using MediaDevices API) ---
        
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let audioPlayer = null;

        const updateRecordingState = () => {
            const recordBtn = document.getElementById('record-btn');
            const playBtn = document.getElementById('play-btn');

            if (recordBtn) {
                const isRecording = mediaRecorder && mediaRecorder.state === 'recording';
                recordBtn.textContent = isRecording ? 'Stop Recording' : 'Start Recording';
                recordBtn.classList.toggle('bg-red-600', isRecording);
                recordBtn.classList.toggle('hover:bg-red-700', isRecording);
                recordBtn.classList.toggle('bg-indigo-600', !isRecording);
                recordBtn.classList.toggle('hover:bg-indigo-700', !isRecording);
                recordBtn.style.boxShadow = isRecording ? '0 4px #dc2626' : '0 4px #4f46e5';
            }
            if (playBtn) {
                playBtn.disabled = !audioBlob;
                playBtn.classList.toggle('bg-gray-500', !audioBlob);
                playBtn.classList.toggle('hover:bg-gray-600', !audioBlob);
                playBtn.classList.toggle('bg-green-600', !!audioBlob);
                playBtn.classList.toggle('hover:bg-green-700', !!audioBlob);
                playBtn.style.boxShadow = !!audioBlob ? '0 4px #15803d' : '0 4px #4b5563';
            }
        };


        window.toggleRecording = async () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                showNotification('Recording finished. You can now play it back.', 'success');
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    audioBlob = null;

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        stream.getTracks().forEach(track => track.stop()); 
                        updateRecordingState();
                    };

                    mediaRecorder.start();
                    updateRecordingState();
                    showNotification('Recording started! Try saying one of the answers.', 'info');
                    
                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    showNotification('No se pudo acceder al micrófono. Asegúrate de dar permiso.', 'error');
                }
            }
        };

        window.playRecording = () => {
            if (audioBlob) {
                if (audioPlayer) {
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                }
                
                audioPlayer = new Audio(URL.createObjectURL(audioBlob));
                audioPlayer.play();
                showNotification('Playing back your recording...', 'info');
            } else {
                showNotification('No hay grabación para reproducir.', 'warning');
            }
        };

        // --- MAIN RENDER FUNCTION ---

        const renderApp = () => {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';

            // Set container visibility
            const isConversation = window.currentMode === 'conversations';
            document.getElementById('flashcard-container').style.display = isConversation ? 'none' : 'block';
            document.getElementById('conversation-container').style.display = isConversation ? 'block' : 'none';
            document.getElementById('lesson-nav-container').style.display = (window.currentMode === 'practice') ? 'block' : 'none';

            // Render Flashcard View
            if (!isConversation) {
                renderFlashcardView();
            } else {
                renderConversationPractice();
                updateRecordingState(); // Update buttons when entering conversation mode
            }
        };

        const renderFlashcardView = () => {
            const list = window.activeCardList;
            const card = list[window.currentCardIndex];
            const isReviewMode = window.currentMode === 'review';
            const flashcardContainer = document.getElementById('flashcard-container');
            const navContainer = document.getElementById('lesson-nav');

            flashcardContainer.classList.remove('hidden');

            // 1. Render Mode Display 
            document.getElementById('current-mode-display').textContent = isReviewMode ? 'Speed Review' : 'Practice';
            document.getElementById('btn-start-review').style.display = isReviewMode ? 'none' : 'block';

            // 2. Render Lesson Navigation (Practice Mode Only)
            if (window.currentMode === 'practice') {
                navContainer.innerHTML = LESSONS.map((l, index) => {
                    const isActive = index === window.currentLessonIndex;
                    const isDone = window.currentProgress[l.progressKey];
                    return `
                        <button onclick="selectLesson(${index})"
                            class="p-3 text-sm font-medium rounded-xl transition duration-150 ease-in-out
                            ${isActive ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-indigo-50 hover:text-indigo-600'}
                            ${isDone && !isActive ? 'border-2 border-green-500 text-green-700' : 'border border-gray-200'}
                            ">
                            ${l.title}
                            ${isDone ? '<span class="ml-2">✅</span>' : ''}
                        </button>
                    `;
                }).join('');
            }

            // --- Lógica para el AUDIO: toma el texto antes del primer paréntesis ---
            const audioText = (card.frenchAudio || card.french).split('(')[0].trim();

            // 3. Render Card Container and Details
            const cardContainer = document.getElementById('card-container');
            const cardDetail = document.getElementById('card-detail');

            cardContainer.innerHTML = `
                <div id="flip-container" class="flip-container h-80 w-full" onclick="flipCard()">
                    <div class="front">
                        <div class="text-center">
                            <p class="text-2xl font-semibold mb-2 text-gray-500">French</p>
                            <h2 class="text-5xl font-extrabold">${card.french}</h2>
                            <p class="text-2xl font-semibold mb-6 phonetic">${card.phonetic}</p>
                            <button id="listen-button-main" onclick="event.stopPropagation(); handleListenClick('${audioText.replace(/'/g, "\\'")}')" 
                                class="listen-btn mt-6 flex items-center justify-center mx-auto text-lg hover:shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2 w-5 h-5 mr-2">
                                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                                </svg>
                                Listen
                            </button>
                            <p class="mt-4 text-sm text-gray-400">Click card to reveal English!</p>
                            ${isReviewMode ? `<p class="mt-2 text-xs text-indigo-400">From: ${card.lessonTitle}</p>` : ''}
                        </div>
                    </div>
                    <div class="back">
                        <div class="text-center">
                            <p class="text-2xl font-semibold mb-2 text-indigo-200">English Translation</p>
                            <h2 class="text-4xl font-extrabold">${card.english}</h2>
                            ${isReviewMode ? `<p class="mt-4 text-sm text-indigo-200">${card.lessonTitle}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
            if (window.isFlipped) {
                document.getElementById('flip-container').classList.add('flipped');
            }

            // 4. Render Card Details and Navigation
            const totalCards = list.length;
            const currentCardNumber = window.currentCardIndex + 1;
            
            let detailText = `Card: ${currentCardNumber} of ${totalCards}`;
            if (!isReviewMode) {
                const lesson = LESSONS[window.currentLessonIndex];
                const isCompleted = window.currentProgress[lesson.progressKey];
                detailText = `Lesson: <span class="font-semibold">${lesson.title}</span> | ${detailText} ${isCompleted ? ' (COMPLETED)' : ''}`;
            } else {
                 detailText = `Mode: <span class="font-semibold">Speed Review</span> | ${detailText}`;
            }

            cardDetail.innerHTML = `<p class="text-sm text-gray-500 mt-4">${detailText}</p>`;

            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const isLastCard = window.currentCardIndex === totalCards - 1;

            btnPrev.disabled = window.currentCardIndex === 0;
            btnPrev.onclick = prevCard;
            btnNext.onclick = nextCard;
            
            if (isLastCard) {
                btnNext.textContent = isReviewMode ? "Finish Review" : "Mark Complete & Next Lesson";
                btnNext.className = `p-3 rounded-xl font-semibold transition duration-150 bg-green-600 text-white hover:bg-green-700`;
            } else {
                btnNext.textContent = "Next Card";
                btnNext.className = `p-3 rounded-xl font-semibold transition duration-150 bg-indigo-600 text-white hover:bg-indigo-700`;
            }
            btnPrev.className = `p-3 rounded-xl font-semibold transition duration-150 ${window.currentCardIndex === 0 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`;
        };

        const renderConversationPractice = () => {
            const currentConv = CONVERSATIONS[window.currentConversationIndex];
            const convContainer = document.getElementById('conversation-container');
            const totalConvs = CONVERSATIONS.length;
            
            convContainer.classList.remove('hidden');
            document.getElementById('current-mode-display').textContent = 'Conversations';

            // Main Conversation Card
            convContainer.innerHTML = `
                <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6">
                    <div class="text-center pb-4 border-b border-gray-100">
                        <p class="text-xl font-bold text-indigo-600">Topic: ${currentConv.topic}</p>
                        <p class="text-sm text-gray-500">Scenario ${window.currentConversationIndex + 1} of ${totalConvs}</p>
                    </div>

                    <div class="mt-6 p-4 bg-indigo-50 rounded-xl border border-indigo-200 shadow-inner">
                        <p class="text-sm font-semibold text-indigo-700 mb-2">Question:</p>
                        <h3 class="text-3xl font-extrabold text-indigo-900 mb-2">${currentConv.question}</h3>
                        <p class="text-lg font-semibold phonetic">${currentConv.answers[0].phonetic.split('/').slice(0, 2).join('/').replace(',', '')}...</p>
                        <button id="listen-button-q" onclick="handleListenClick('${currentConv.question.replace(/'/g, "\\'")}')" 
                            class="listen-btn mt-3 flex items-center justify-center text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                            Listen Question
                        </button>
                    </div>

                    <h4 class="text-xl font-bold text-gray-700 mt-8 mb-4">Choose and Practice Your Answer:</h4>
                    
                    <div class="p-4 bg-white rounded-xl border border-gray-300 shadow-lg mb-4">
                        <p class="text-2xl font-medium text-gray-800">${currentConv.answers[0].text}</p>
                        <p class="text-sm font-semibold phonetic mb-3">${currentConv.answers[0].phonetic}</p>
                        <button id="listen-button-a1" onclick="handleListenClick('${currentConv.answers[0].text.replace(/'/g, "\\'")}')" 
                            class="listen-btn flex items-center justify-center text-sm px-3 py-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                            Listen Sample
                        </button>
                    </div>

                    <div class="p-4 bg-white rounded-xl border border-gray-300 shadow-lg">
                        <p class="text-2xl font-medium text-gray-800">${currentConv.answers[1].text}</p>
                        <p class="text-sm font-semibold phonetic mb-3">${currentConv.answers[1].phonetic}</p>
                        <button id="listen-button-a2" onclick="handleListenClick('${currentConv.answers[1].text.replace(/'/g, "\\'")}')" 
                            class="listen-btn flex items-center justify-center text-sm px-3 py-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                            Listen Sample
                        </button>
                    </div>
                </div>

                <div class="flex justify-center space-x-4 p-4 bg-indigo-100 rounded-2xl shadow-inner">
                    <button id="record-btn" onclick="toggleRecording()" class="action-btn flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                        Start Recording
                    </button>
                    <button id="play-btn" onclick="playRecording()" disabled class="action-btn flex items-center text-sm bg-gray-500 hover:bg-gray-600 disabled:bg-gray-400 disabled:cursor-not-allowed" style="box-shadow: 0 4px #4b5563;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        Play My Recording
                    </button>
                </div>

                <div class="flex justify-between items-center mt-6">
                    <button onclick="prevConversation()" class="p-3 rounded-xl font-semibold transition duration-150 bg-gray-300 text-gray-700 hover:bg-gray-400 ${window.currentConversationIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${window.currentConversationIndex === 0 ? 'disabled' : ''}>
                        < Previous Topic
                    </button>
                    <button onclick="nextConversation()" class="p-3 rounded-xl font-semibold transition duration-150 bg-indigo-600 text-white hover:bg-indigo-700">
                        Next Topic >
                    </button>
                </div>
            `;
        };

        window.onload = () => {
            initFirebase();
            if (synth.onvoiceschanged === undefined) { 
                setFrenchVoice();
            }
        };
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="notification-box" style="opacity: 0; transition: opacity 0.3s;"></div>

    <header class="max-w-xl mx-auto mb-8">
        <h1 class="text-4xl font-extrabold text-indigo-700">🇫🇷 French Companion</h1>
        <p id="user-id-display" class="text-sm text-gray-500 mt-1">Initializing...</p>
        <div class="flex space-x-3 mt-4">
            <button onclick="changeView('practice')" class="px-4 py-2 text-sm font-bold rounded-xl transition duration-150 shadow-md"
                style="background-color: var(--color-practice); color: var(--color-practice-text);"
                :class="{'bg-indigo-600 text-white': currentMode !== 'conversations', 'bg-white text-gray-700 border border-gray-300': currentMode === 'conversations'}">
                Flashcards
            </button>
            <button onclick="changeView('conversations')" class="px-4 py-2 text-sm font-bold rounded-xl transition duration-150 shadow-md"
                style="background-color: var(--color-conversations); color: var(--color-conversations-text);"
                :class="{'bg-green-600 text-white': currentMode === 'conversations', 'bg-white text-gray-700 border border-gray-300': currentMode !== 'conversations'}">
                Conversations
            </button>
        </div>
    </header>

    <div id="loading-state" class="max-w-xl mx-auto text-center mt-20 p-8 bg-white rounded-2xl shadow-xl">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto"></div>
        <p id="loading-message" class="mt-4 text-indigo-700 font-semibold">Loading lessons and tracking progress...</p>
    </div>

    <main id="main-content" class="max-w-xl mx-auto" style="display: none;">

        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 p-4 bg-indigo-50 rounded-2xl shadow-inner">
            <h2 class="text-lg font-semibold text-indigo-700 mb-2 sm:mb-0">Current Mode: <span id="current-mode-display" class="capitalize font-extrabold text-indigo-900">Practice</span></h2>
            <button id="btn-start-review" onclick="startSpeedReview()" class="px-4 py-2 w-full sm:w-auto text-sm font-bold bg-pink-600 text-white rounded-xl hover:bg-pink-700 transition duration-150 shadow-lg">
                🚀 Start Speed Review
            </button>
        </div>

        <div id="conversation-container" class="hidden">
            </div>
        
        <div id="flashcard-container">
            <div id="lesson-nav-container">
                <nav id="lesson-nav" class="flex flex-wrap gap-3 mb-6 p-4 bg-white rounded-2xl shadow-md"></nav>
            </div>

            <section class="bg-white rounded-3xl shadow-2xl overflow-hidden p-6 mb-6 lesson-card">
                <div id="card-container" class="relative h-80">
                    </div>
            </section>

            <div class="flex flex-col sm:flex-row justify-between items-center p-4 bg-white rounded-2xl shadow-md">
                <div id="card-detail" class="mb-4 sm:mb-0">
                    </div>
                <div class="flex space-x-3 w-full sm:w-auto">
                    <button id="btn-prev" onclick="prevCard()" class="flex-1">
                        < Back
                    </button>
                    <button id="btn-next" onclick="nextCard()" class="flex-1">
                        Next Card
                    </button>
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-gray-400 text-xs">
            Progress is automatically saved to your user ID using Google Firestore.
        </footer>

    </main>

</body>
</html>
